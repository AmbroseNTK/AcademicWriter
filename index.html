<html>

<head>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@2.0.1/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/underscore@1.13.2/underscore-umd-min.js"></script>
</head>

<body>
    <textarea id="mainInput" style="width: 90%;"></textarea>
    <script>

        let index2word = {};
        let word2index = {};
        let model = null;
        const max_len = 65;
        let executed = false;
        let previousInput = null;

        async function loadModel() {
            model = await tf.loadLayersModel('./model_js/model.json');
            input = []
            for (let i = 0; i < 65; i++) {
                input.push(0)
            }
            result = model.predict(tf.tensor2d([input]));
            console.log(result.dataSync());
            // for(let i=0;i<result.length;i++){
            //     console.log(result[i]);
            // }
            index2word = await fetch("./index2word.json").then(response => response.json())
            word2index = await fetch("./word2index.json").then(response => response.json())
            console.log(encode("As we can say that"));

        }
        function encode(input) {
            input = input.split(' ');

            let encoded = [];
            for (let i = 0; i < input.length; i++) {
                if (input[i] == "") { continue; }
                let r = word2index[input[i].toLowerCase().trim()];
                if (r == undefined) {
                    r = 1;
                }
                encoded.push(r);
            }
            for (let i = 0; i < max_len - input.length; i++) {
                encoded.unshift(0);
            }
            while (encoded.length > max_len) {
                encoded.shift();
            }
            return encoded;
        }
        function predict(input, nextLen) {
            let result = "";
            for (let i = 0; i < nextLen; i++) {
                let token = encode(input);
                let probs = model.predict(tf.tensor2d([token]));
                let probs_array = probs.dataSync();
                let max_index = 0;
                let max_prob = 0;
                let candidates = []
                // Get top-10 max prob
                let top_5 = [...probs_array]
                top_5 = top_5.sort((a, b) => b - a).slice(0, 5);
                for (let i = 0; i < top_5.length; i++) {
                    for (let j = 0; j < probs_array.length; j++) {
                        if (probs_array[j] == top_5[i]) {
                            candidates.push(j);
                        }
                    }
                }
                console.log(candidates);
                candidates.sort((a, b) => 0.5 - Math.random());
                input += " " + index2word[candidates[0]];
                result += " " + index2word[candidates[0]];
            }
            return result.trim();
        }

        function suggest(input) {

            executed = true;
            let result = [];
            try {

                const sentences = input.split('.');
                let inp = "";
                if (sentences.length == 1) {
                    inp = sentences[0].toLowerCase().trim();
                }
                else {
                    inp = sentences[sentences.length - 2].toLowerCase().trim() + ". " + sentences[sentences.length - 1].toLowerCase().trim();
                }
                for (let k = 0; k < 4; k++) {
                    for (let i = 3; i < 7; i++) {
                        let r = predict(inp, i);
                        if (result.indexOf(r) == -1) {
                            result.push(r);
                        }
                    }
                }
                console.log(result);
            }
            catch (e) {
            }
            return result;
        }


        let typingTimer;                //timer identifier
        let doneTypingInterval = 1000;  //time in ms (5 seconds)
        let mainInput = document.getElementById('mainInput');

        //on keyup, start the countdown
        mainInput.addEventListener('keyup', () => {
            clearTimeout(typingTimer);
            if (mainInput.value) {
                typingTimer = setTimeout(doneTyping, doneTypingInterval);
            }
        });


        function doneTyping() {
            let input = mainInput.value;
            let result = suggest(input);
            console.log(result);
        }

        loadModel();



    </script>

</body>

</html>